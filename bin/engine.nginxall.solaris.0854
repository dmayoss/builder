#!/usr/bin/ksh93
#
#  SDR Development tools, Solaris NGINX engine 
#
#  Copyright (c) 2014 Stefan Parvu (www.systemdatarecorder.org).
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of the GNU General Public License
#  as published by the Free Software Foundation; either version 2
#  of the License, or (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software Foundation,
#  Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
#
#  (http://www.gnu.org/copyleft/gpl.html)

# ############################################################### #
# NGINX Engine: Solaris                                           #
#  Includes: PHP, MariaDB                                         #
#    build_nginx_perl                                             #
#    build_nginx_ossl                                             #
#    build_nginx_gettext                                          #
#    build_nginx_iconv                                            #
#    build_nginx_gettext                                          #
#    build_nginx_readline                                         #
#    build_nginx_gd                                               #
#    build_nginx_perlmods                                         #
#    build_nginx_pcre                                             #
#    build_nginx_fcgi                                             #
#    build_nginx_ws                                               #
#    build_nginx_fcgiwrap                                         #
#    build_nginx_dbdpg                                            #
#    build_nginx_scripts                                          #
#                                                                 #
#  - /opt/www/                                                    #
#    - nginx/                                                     #
#    - mariadb/                                                   #
#    - php/                                                       #
#    - perl/                                                      #
#    - mcd/                                                       #
#    - logs/                                                      #
#    - docroot/                                                   #
#    - mariadb_data/                                              #
#    - src/                                                       #
# ############################################################### #


# ############################################################### #
# extract_archive                                                 #
# ############################################################### #
extract_archive() {
# $1 module name
# $2 dir build

modfile=$1
bfile=$2

# Debug
# print "module name: $modfile"
# print "archive dir: $bfile"

if [[ -d $bfile ]]; then
    print "Info: Step 1 - Extracting $bfile ..." |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    print "Warning: ${bfile} directory found, cleaning..." |\
     tee -a ${BUILD_LOG}/${module}.${version}.log

    rm -rf ${bfile}
    if (( $? != 0 )); then
        print "Error: cannot clean. Check ${modfile} , ${bfile}" |\
         tee -a ${BUILD_LOG}/${module}.${version}.log
        exit 3
    fi 
    gzip -dc ${bfile}.tar.gz | tar xvf - >> ${BUILD_LOG}/${module}.${version}.log
else
    print "Info: Step 1 - Extracting $bfile ..." |\
    tee -a ${BUILD_LOG}/${module}.${version}.log
    gzip -dc ${bfile}.tar.gz | tar xvf - >> ${BUILD_LOG}/${module}.${version}.log
fi

}


# ############################################################### #
# NGINX: Perl Build Phase                                         #
# ############################################################### #
build_nginx_perl() {
dir=perl
step1=0
step2=0
step3=0
step4=0
step5=0
step6=0

cd $dir
print "\n##################################################"
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Submodule: $dir" | tee -a ${BUILD_LOG}/${module}.${version}.log
ls *.tar.gz | read archive_file
# Debug
# print "Archive: $archive_file"
# print "Dir: ${archive_file%%.tar*}"

dirarchive=${archive_file%%.tar*}

# STEP 1
extract_archive "$dir" "$dirarchive"
if (( $? == 0)); then
    step1=1
fi

# STEP 2
cd ${archive_file%%.tar*}

print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 2 - Configure perl ..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log

sh Configure -Dcc='cc' -Doptimize='-xO3' -Duselargefiles -Duse64bitall \
             -Dcf_by="support@systemdatarecorder.org"       \
             -Dcf_email="support@systemdatarecorder.org"    \
             -Dprefix=/opt/www/perl -des >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: configure perl failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    # fix config.sh
    # Workaround: Bug 32 - SDR Perl - Memory leak in Perl 5.10+
    # on Solaris 10 with %ENV remove flag: -DPERL_USE_SAFE_PUTENV

    # fix ldflags
    print "Fixing ldflags..." >> ${BUILD_LOG}/${module}.${version}.log
    sed 's/\-xarch=generic64 \-L\/opt\/sunstudio12.1\/prod\/lib\/amd64 \-L\/lib\/64/\-m64 \-L\/lib\/64/' config.sh > config.sh.tmp
    if (( $? != 0 )); then
        print "Error: fixing ldflags perl failed !" |\
         tee -a ${BUILD_LOG}/${module}.${version}.log
        rm /var/tmp/build.${module}
        exit 3
    fi

    mv config.sh.tmp config.sh


    # fix libpath, libspath
    print "Fixing libspath..." >> ${BUILD_LOG}/${module}.${version}.log
    sed 's/\/opt\/sunstudio12.1\/prod\/lib\/amd64 \/lib\/64 \/usr\/lib \/usr\/ccs\/lib/\/lib\/64 \/usr\/lib \/usr\/ccs\/lib/' config.sh > config.sh.tmp
    if (( $? != 0 )); then
        print "Error: fixing libpath perl failed !" |\
         tee -a ${BUILD_LOG}/${module}.${version}.log
        rm /var/tmp/build.${module}
        exit 3
    fi
    mv config.sh.tmp config.sh

    # fix loclibpth
    print "Fixing loclibpth..." >> ${BUILD_LOG}/${module}.${version}.log 
    sed 's/\/opt\/sunstudio12.1\/prod\/lib\/amd64 \/amd64 \/lib\/64 \/64 \/usr\/local\/lib \/opt\/local\/lib \/usr\/gnu\/lib \/opt\/gnu\/lib \/usr\/GNU\/lib \/opt\/GNU\/lib/\/amd64 \/lib\/64 \/64 \/usr\/lib \/usr\/ccs\/lib/' config.sh > config.sh.tmp
    if (( $? != 0 )); then
        print "Error: fixing loclibpth perl failed !" |\
         tee -a ${BUILD_LOG}/${module}.${version}.log
        rm /var/tmp/build.${module}
        exit 3
    fi
    mv config.sh.tmp config.sh
    
    # fix ccflags
    print "Fixing ccflags..." >> ${BUILD_LOG}/${module}.${version}.log
    sed 's/\-xarch=generic64 \-D_LARGEFILE_SOURCE \-D_FILE_OFFSET_BITS=64 \-DPERL_USE_SAFE_PUTENV/\-m64 \-D_LARGEFILE_SOURCE \-D_FILE_OFFSET_BITS=64/' config.sh > config.sh.tmp
    if (( $? != 0 )); then
        print "Error: fixing ccflags perl failed !" |\
         tee -a ${BUILD_LOG}/${module}.${version}.log
        rm /var/tmp/build.${module}
        exit 3
    fi
    mv config.sh.tmp config.sh

    # fix cppflags
    print "Fixing cppflags..." >> ${BUILD_LOG}/${module}.${version}.log
    sed 's/\-xarch=generic64/\-m64/' config.sh > config.sh.tmp
    if (( $? != 0 )); then
        print "Error: fixing cppflags perl failed !" |\
         tee -a ${BUILD_LOG}/${module}.${version}.log
        rm /var/tmp/build.${module}
        exit 3
    fi
    mv config.sh.tmp config.sh
 
    sh Configure -S >> ${BUILD_LOG}/${module}.${version}.log 2>&1
    make depend >> ${BUILD_LOG}/${module}.${version}.log 2>&1
    if (( $? != 0 )); then
        print "Error: make depend perl failed !" |\
         tee -a ${BUILD_LOG}/${module}.${version}.log
        rm /var/tmp/build.${module}
        exit 3
    else
        step2=1
    fi
fi

# STEP 3
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 3 - Make perl..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
make >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make perl failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step3=1
fi

# STEP 4
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 4 - Make test perl..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
make test >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make test perl failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step4=1
fi

# STEP 5
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 5 - Make install perl..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
 
if [[ -d /opt/www/perl ]]; then
    print "Warning: perl directory found, cleaning it..." |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm -rf /opt/www/perl
    if (( $? != 0 )); then
        print "Error: cleaning $dir directory" |\
         tee -a ${BUILD_LOG}/${module}.${version}.log
        rm /var/tmp/build.${module}
        exit 3
    fi
fi
 
make install >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make install perl failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step5=1
fi


# STEP 6

print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 6 - CPAN modules" | tee -a ${BUILD_LOG}/${module}.${version}.log

cp /opt/build/cpan/Config.pm /opt/www/perl/lib/5.12.2/CPAN
${NGALL_PERLBIN}/perl -MCPAN -e 'install Bundle::LWP' >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: Bundle::LWP installation failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    (( step6 = step6 + 1))
fi

for lib in CGI FCGI CGI::Simple CGI::Minimal FCGI::ProcManager \
    IO::All HTTP::Async Email::Valid MIME::Lite Date::Format Date::Parse \
    Date::Calc HTML::Parser HTML::Entities Digest::SHA DateTime \
    DateTime::Timezone DBI Template Email::Send Email::MIME \
    Email::MIME::Encodings Email::MIME::Modifier \
    URI Email::MIME::Attachment::Stripper Email::Reply HTML::Scrubber \
    MIME::Parser Authen::SASL Captcha::reCAPTCHA
do
    if [[ $lib == "MIME::Lite" ]]; then
        env PERL_MM_USE_DEFAULT=1 \
          ${NGALL_PERLBIN}/perl -MCPAN -e 'install "'$lib'"' >> \
          ${BUILD_LOG}/${module}.${version}.log 2>&1
        if (( $? != 0 )); then
            tee -a ${BUILD_LOG}/${module}.${version}.log
            exit 3
        else
            ((step6 = step6 + 1))
            continue
        fi
    fi

    ${NGALL_PERLBIN}/perl -MCPAN -e 'install "'$lib'"' >> ${BUILD_LOG}/${module}.${version}.log 2>&1
    if (( $? != 0 )); then
        print "Error: $lib installation failed !" |\
         tee -a ${BUILD_LOG}/${module}.${version}.log
        rm /var/tmp/build.${module}
        exit 3
    else
        ((step6 = step6 + 1))
    fi
done


# there are 31 perl modules install calls 
(( step6 = step6 / 31 ));


# final check; all 6 steps
(( ngx_perl_done = step1 + step2 + step3 + step4 + step5 + step6 ))
if (( ngx_perl_done == 6 )); then
  ngx_ perl_done=1
else
  ngx_perl_done=0
fi

print "##################################################"

cd ../..

}

# ############################################################### #
# NGINX ALL: readline Build Phase                                 #
# ############################################################### #

build_nginx_readline() {
dir=readline
step1=0
step2=0
step3=0
step4=0


cd $dir
print "\n##################################################"
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Submodule: $dir" | tee -a ${BUILD_LOG}/${module}.${version}.log
ls *.tar.gz | read archive_file
# Debug
# print "Archive: $archive_file"
# print "Dir: ${archive_file%%.tar*}"

dirarchive=${archive_file%%.tar*}

# STEP 1
extract_archive "$dir" "$dirarchive"
if (( $? == 0)); then
    step1=1
fi

# STEP 2
cd ${archive_file%%.tar*}

print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 2 - Configure $dir ..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log

env PATH=/opt/www/bin:/opt/www/perl/bin:$PATH \
CC=cc CFLAGS="-m64 -xO3 -I/opt/www/include" \
LDFLAGS="-m64 -L/opt/www/lib -R/opt/www/lib" \
./configure --prefix=/opt/www >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: configure $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step2=1
fi

# STEP 3
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 3 - Make $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
make >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step3=1
fi

# STEP 4
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 4 - Make install $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log


make install >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make install gd failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step4=1
fi

# final check; all 4 steps
(( ngx_rdln_done = step1 + step2 + step3 + step4 ))
if (( ngx_rdln_done == 4 )); then
  ngx_rdln_done=1
else
   ngx_rdln_done=90
fi

cd ../..

}


# ############################################################### #
# NGINX ALL: gettext Build Phase                                  #
# ############################################################### #
build_nginx_gettext() {
dir=gettext
step1=0
step2=0
step3=0
step4=0


cd $dir
print "\n##################################################"
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Submodule: $dir" | tee -a ${BUILD_LOG}/${module}.${version}.log
ls *.tar.gz | read archive_file
# Debug
# print "Archive: $archive_file"
# print "Dir: ${archive_file%%.tar*}"

dirarchive=${archive_file%%.tar*}

# STEP 1
extract_archive "$dir" "$dirarchive"
if (( $? == 0)); then
    step1=1
fi

# STEP 2
cd ${archive_file%%.tar*}

print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 2 - Configure $dir ..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
 
env PATH=/opt/www/bin:/opt/www/perl/bin:$PATH \
    CC=cc CXX="/usr/bin/CC -lCrun" CFLAGS="-m64 -xO3" CXXFLAGS="-m64 -xO3" \
    LDFLAGS="-m64 -L/opt/www/lib -R/opt/www/lib" \
    ./configure --prefix=/opt/www >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: configure $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    exit 3
else
    step2=1
fi


# STEP 3
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 3 - Make $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log

make >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    exit 3
else
    step3=1
fi


# STEP 4
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 4 - Make install $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log

make install >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make install perl failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    exit 3
else
    step4=1
fi


# final check; all 4 steps
(( ngx_gett_done = step1 + step2 + step3 + step4 ))
if (( ngx_gett_done == 4 )); then
   ngx_gett_done=1
else
   ngx_gett_done=90
fi

cd ../..

}


# ############################################################### #
# NGINX: iconv Build Phase                                           #
# ############################################################### #

build_nginx_iconv() {
dir=iconv
step1=0
step2=0
step3=0
step4=0


cd $dir
print "\n##################################################"
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Submodule: $dir" | tee -a ${BUILD_LOG}/${module}.${version}.log
ls *.tar.gz | read archive_file
# Debug
# print "Archive: $archive_file"
# print "Dir: ${archive_file%%.tar*}"

dirarchive=${archive_file%%.tar*}

# STEP 1
extract_archive "$dir" "$dirarchive"
if (( $? == 0)); then
    step1=1
fi

# STEP 2
cd ${archive_file%%.tar*}

print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 2 - Configure $dir ..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
 
env PATH=/opt/www/bin:/opt/www/perl/bin:$PATH CC=cc CFLAGS="-m64 -xO3" LDFLAGS="-m64 -L/lib/64 -L/usr/lib/64 -L/usr/sfw/lib/amd64 -R/usr/sfw/lib/amd64" ./configure \
 --prefix=/opt/www >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: configure $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step2=1
fi  

# STEP 3
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 3 - Make $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
make >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step3=1
fi 

# STEP 4
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 4 - Make install $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log


make install >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make install gd failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step4=1
fi

# final check; all 4 steps
(( ngx_iconv_done = step1 + step2 + step3 + step4 ))
if (( ngx_iconv_done == 4 )); then
   ngx_iconv_done=1
else
   ngx_conv_done=0
fi

cd ../..

}


# ############################################################### #
# NGINX: openssl Build Phase                                      #
# ############################################################### #

build_nginx_ossl() {
dir=openssl
step1=0
step2=0
step3=0
step4=0


cd $dir
print "\n##################################################"
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Submodule: $dir" | tee -a ${BUILD_LOG}/${module}.${version}.log
ls *.tar.gz | read archive_file
# Debug
# print "Archive: $archive_file"
# print "Dir: ${archive_file%%.tar*}"

dirarchive=${archive_file%%.tar*}

# STEP 1
extract_archive "$dir" "$dirarchive"
if (( $? == 0)); then
    step1=1
fi

# STEP 2
cd ${archive_file%%.tar*}

print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 2 - Configure $dir ..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
 
env PATH=/opt/www/perl/bin:/opt/www/bin:$PATH \
 ./Configure solaris64-x86_64-cc threads shared --prefix=/opt/www \
 --openssldir=/opt/www/openssl >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: configure $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step2=1
fi  

# STEP 3
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 3 - Make $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log

# fix xarch
print "Fixing arch flag..." >> ${BUILD_LOG}/${module}.${version}.log
sed 's/\-xarch\=amd64/\-m64/g' Makefile > Makefile.tmp
if (( $? != 0 )); then
    print "Error: fixing xarch Makefile failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
fi
mv Makefile.tmp Makefile

print "Fixing SHARED_LDFLAGS flag..." >> ${BUILD_LOG}/${module}.${version}.log
sed 's/SHARED_LDFLAGS\=\-m64 \-G \-dy \-z text/SHARED_LDFLAGS\=\-m64 \-G \-dy \-z text \-L\/opt\/www\/lib \-R\/opt\/www\/lib/' Makefile > Makefile.tmp
if (( $? != 0 )); then
    print "Error: fixing SHARED_LDFLAGS Makefile failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
fi
mv Makefile.tmp Makefile



make >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step3=1
fi 


# STEP 4
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 4 - Make install $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log

make install >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make install perl failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step4=1
fi


# final check; all 4 steps
(( ngx_ossl_done = step1 + step2 + step3 + step4 ))
if (( ngx_ossl_done == 4 )); then
   ngx_ossl_done=1
else
   ngx_ossl_done=0
fi

cd ../..

}



# ############################################################### #
# NGINX: GD Build Phase                                           #
# ############################################################### #

build_nginx_gd() {
dir=gd
step1=0
step2=0
step3=0
step4=0


cd $dir
print "\n##################################################"
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Submodule: $dir" | tee -a ${BUILD_LOG}/${module}.${version}.log
ls *.tar.gz | read archive_file
# Debug
# print "Archive: $archive_file"
# print "Dir: ${archive_file%%.tar*}"

dirarchive=${archive_file%%.tar*}

# STEP 1
extract_archive "$dir" "$dirarchive"
if (( $? == 0)); then
    step1=1
fi

# STEP 2
cd ${archive_file%%.tar*}

print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 2 - Configure $dir ..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
 
env PATH=/opt/www/bin:/opt/www/perl/bin:$PATH \
    CC=cc CFLAGS="-m64 -xO3" LDFLAGS="-m64 -L/lib/64 -L/usr/lib/64 \
      -L/usr/sfw/lib/amd64 -R/usr/sfw/lib/amd64" ./configure \
    --prefix=/opt/www >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: configure $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step2=1
fi  

# STEP 3
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 3 - Make $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
make >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step3=1
fi 

# STEP 4
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 4 - Make install $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log


make install >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make install gd failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step4=1
fi

# final check; all 4 steps
(( ngx_gd_done = step1 + step2 + step3 + step4 ))
if (( ngx_gd_done == 4 )); then
   ngx_gd_done=1
else
   ngx_gd_done=0
fi

cd ../..

}

# ############################################################### #
# NGINX: Perl Modules: GD                                         #
# ############################################################### #

build_nginx_perlmods() {

dir=perlmods
step1=0
step2=0
step3=0
step4=0
step5=0

cd $dir
print "\n##################################################"
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Submodule: $dir" | tee -a ${BUILD_LOG}/${module}.${version}.log
ls *.tar.gz | read archive_file
# Debug
# print "Archive: $archive_file"
# print "Dir: ${archive_file%%.tar*}"

dirarchive=${archive_file%%.tar*}

# STEP 1
extract_archive "$dir" "$dirarchive"
if (( $? == 0)); then
    step1=1
fi

# STEP 2
cd ${archive_file%%.tar*}

print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 2 - Configure $dir ..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log

env PATH=/opt/www/bin:$PATH \
 ${NGALL_PERLBIN}/perl Makefile.PL  >> ${BUILD_LOG}/${module}.${version}.log 2>&1

# LDFLAGS =  -m64 -L/lib/64 
sed 's/LDFLAGS \=  \-m64 \-L\/lib\/64/LDFLAGS \= \-m64 \-L\/lib\/64 \-L\/usr\/sfw\/lib\/amd64 \-R\/usr\/sfw\/lib\/amd64 \-L\/opt\/www\/lib \-R\/opt\/www\/lib/' Makefile > Makefile.tmp
mv Makefile.tmp Makefile

# LDDLFLAGS =  -G -m64 -L/lib/64
sed 's/LDDLFLAGS \=  \-G \-m64 \-L\/lib\/64/LDDLFLAGS \= \-G \-m64 \-L\/usr\/sfw\/lib\/amd64 \-R\/usr\/sfw\/lib\/amd64 \-L\/lib\/64 \-L\/opt\/www\/lib \-R\/opt\/www\/lib/' Makefile > Makefile.tmp
mv Makefile.tmp Makefile


# CCFLAGS
sed 's/^CCFLAGS.*/CCFLAGS \= \-m64/' Makefile > Makefile.tmp
mv Makefile.tmp Makefile

if (( $? != 0 )); then
    print "Error: configure $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step2=1
fi


# STEP 3
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 3 - Make $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
make >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step3=1
fi 


# STEP 4
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 4 - Make install $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log

make install >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make install perl failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step4=1
fi

# STEP 5
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 5 - Install CPAN GD modules..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log

for lib in GD::Text GD::Graph Chart::Base Template::Plugin::GD::Image
do
    env PERL_MM_USE_DEFAULT=1 \
      ${NGALL_PERLBIN}/perl -MCPAN -e 'install "'$lib'"' >> \
        ${BUILD_LOG}/${module}.${version}.log 2>&1
        if (( $? != 0 )); then
            tee -a ${BUILD_LOG}/${module}.${version}.log
            exit 3
        else
            ((step5 = step5 + 1))
        fi
done

# there are 4 perl modules install calls
(( step5 = step5 / 4 ));


#
# final check; all 5 steps
(( ngx_perlmodules_done = step1 + step2 + step3 + step4 + step5))
if (( ngx_perlmodules_done == 5 )); then
   ngx_perlmodules_done=1
else
   ngx_perlmodules_done=0
fi

cd ../..

}


# ############################################################### #
# NGINX: Perl Module: DBD::Pg                                     #
# ############################################################### #

build_nginx_dbdpg() {

dir=dbdpg
step1=0
step2=0
step3=0
step4=0
step5=0

cd $dir
print "\n##################################################"
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Submodule: $dir" | tee -a ${BUILD_LOG}/${module}.${version}.log
ls *.tar.gz | read archive_file
# Debug
# print "Archive: $archive_file"
# print "Dir: ${archive_file%%.tar*}"

dirarchive=${archive_file%%.tar*}

# STEP 1
extract_archive "$dir" "$dirarchive"
if (( $? == 0)); then
    step1=1
fi

# STEP 2
cd ${archive_file%%.tar*}

print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 2 - Configure $dir ..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log

env PATH=/opt/www/bin:$PATH \
 ${NGALL_PERLBIN}/perl Makefile.PL  >> ${BUILD_LOG}/${module}.${version}.log 2>&1

cp ../Makefile.good Makefile
if (( $? != 0 )); then
    print "Error: configure $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step2=1
fi


# STEP 3
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 3 - Make $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
make >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step3=1
fi 


# STEP 4
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 4 - Make install $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log

make install >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make install perl failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step4=1
fi

#
# final check; all 4 steps
(( ngx_dbdpg_done = step1 + step2 + step3 + step4 ))
if (( ngx_dbdpg_done == 4 )); then
   ngx_dbdpg_done=1
else
   ngx_dbdpg_done=0
fi

cd ../..

}


# ############################################################### #
# NGINX: PCRE Build Phase                                         #
# ############################################################### #

build_nginx_pcre() {
dir=pcre
step1=0
step2=0
step3=0
step4=0


cd $dir
print "\n##################################################"
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Submodule: $dir" | tee -a ${BUILD_LOG}/${module}.${version}.log
ls *.tar.gz | read archive_file
# Debug
# print "Archive: $archive_file"
# print "Dir: ${archive_file%%.tar*}"

dirarchive=${archive_file%%.tar*}

# STEP 1
extract_archive "$dir" "$dirarchive"
if (( $? == 0)); then
    step1=1
fi

# STEP 2
cd ${archive_file%%.tar*}

print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 2 - Configure $dir ..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
 
env PATH=/opt/www/bin:/opt/www/perl/bin:$PATH \
    CC=cc CFLAGS="-m64 -xO3" \
    LDFLAGS="-m64 -L/lib/64 -L/usr/lib/64 -L/usr/sfw/lib/amd64 \
     -R/usr/sfw/lib/amd64" \
    ./configure --disable-cpp --enable-utf8 --enable-unicode-properties \
      --prefix=/opt/www >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: configure $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step2=1
fi  

# STEP 3
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 3 - Make $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
make >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step3=1
fi 

# STEP 4
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 4 - Make install $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log


make install >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make install gd failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step4=1
fi

# final check; all 4 steps
(( ngx_pcre_done = step1 + step2 + step3 + step4 ))
if (( ngx_pcre_done == 4 )); then
   ngx_pcre_done=1
else
   ngx_pcre_done=0
fi

cd ../..

}


# ############################################################### #
# NGINX: FCGI Build Phase                                         #
# ############################################################### #

build_nginx_fcgi() {
dir=fcgi
step1=0
step2=0
step3=0
step4=0


cd $dir
print "\n##################################################"
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Submodule: $dir" | tee -a ${BUILD_LOG}/${module}.${version}.log
ls *.tar.gz | read archive_file
# Debug
# print "Archive: $archive_file"
# print "Dir: ${archive_file%%.tar*}"

dirarchive=${archive_file%%.tar*}

# STEP 1
extract_archive "$dir" "$dirarchive"
if (( $? == 0)); then
    step1=1
fi

# STEP 2
cd ${archive_file%%.tar*}

print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 2 - Configure $dir ..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
 
env PATH=/opt/www/bin:/opt/www/perl/bin:$PATH \
    CC=cc CFLAGS="-m64 -xO3 -I/opt/www/include" \
    CXX=CC CXXFLAGS="-xO3 -m64 -I/opt/www/include" \
    LDFLAGS="-m64 -L/lib/64 -L/usr/lib/64 -L/usr/sfw/lib/amd64 \
     -R/usr/sfw/lib/amd64" ./configure \
     --prefix=/opt/www >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: configure $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step2=1
fi  

# STEP 3
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 3 - Make $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
make >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step3=1
fi 

# STEP 4
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 4 - Make install $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log


make install >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make install gd failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step4=1
fi

# final check; all 4 steps
(( ngx_fcgi_done = step1 + step2 + step3 + step4 ))
if (( ngx_fcgi_done == 4 )); then
   ngx_fcgi_done=1
else
   ngx_fcgi_done=0
fi

cd ../..

}


# ############################################################### #
# NGINX: FCGIWRAP Build Phase                                     #
# ############################################################### #

build_nginx_fcgiwrap() {
dir=fcgiwrap
step1=0
step2=0
step3=0


cd $dir
print "\n##################################################"
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Submodule: $dir" | tee -a ${BUILD_LOG}/${module}.${version}.log
ls *.tar.gz | read archive_file
# Debug
# print "Archive: $archive_file"
# print "Dir: ${archive_file%%.tar*}"

dirarchive=${archive_file%%.tar*}

# STEP 1
extract_archive "$dir" "$dirarchive"
if (( $? == 0)); then
    step1=1
fi

# STEP 2
cd ${archive_file%%.tar*}

print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 2 - Make $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
make >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step2=1
fi 

# STEP 3
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 3 - Make install $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log

if [[ ! -d /opt/www/nginx/sbin ]]; then
    mkdir /opt/www/nginx/sbin
fi

make install >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make install fcgiwrap failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step3=1
fi

# final check; all 3 steps
(( ngx_fcgiw_done = step1 + step2 + step3 ))
if (( ngx_fcgi_done == 3 )); then
   ngx_fcgiw_done=1
else
   ngx_fcgiw_done=0
fi

cd ../..

}



# ############################################################### #
# NGINX: WS nginx Build Phase                                     #
# ############################################################### #

build_nginx_ws() {
dir=ws
step1=0
step2=0
step3=0
step4=0


cd $dir
print "\n##################################################"
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Submodule: $dir" | tee -a ${BUILD_LOG}/${module}.${version}.log
ls *.tar.gz | read archive_file
# Debug
# print "Archive: $archive_file"
# print "Dir: ${archive_file%%.tar*}"

dirarchive=${archive_file%%.tar*}

# STEP 1
extract_archive "$dir" "$dirarchive"
if (( $? == 0)); then
    step1=1
fi

# STEP 2
cd ${archive_file%%.tar*}

# copy the fair plugin
cp -pr ../../upstream .

print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 2 - Configure $dir ..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
 
env NGX_AUX=" src/os/unix/ngx_sunpro_amd64.il"       \
    CC=cc CFLAGS="-m64 -xO3"                         \
    ./configure --prefix=/opt/www/nginx --with-ipv6  \
    --with-perl=/opt/www/perl/bin                    \
    --with-http_ssl_module                           \
    --with-http_stub_status_module                   \
    --with-http_realip_module                        \
    --with-http_flv_module                           \
    --with-http_gzip_static_module                   \
    --with-sha1=/usr/lib/amd64                       \
    --with-cc-opt="-I /opt/www/include"              \
    --with-ld-opt="-m64 -L/opt/www/lib -R/opt/www/lib -R/usr/lib/amd64 -R/lib/amd64" \
    --add-module=upstream >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: configure $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step2=1
fi  

# STEP 3
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 3 - Make $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log
make >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make $dir failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step3=1
fi 

# STEP 4
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 4 - Make install $dir..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log


make install >> ${BUILD_LOG}/${module}.${version}.log 2>&1
if (( $? != 0 )); then
    print "Error: make install gd failed !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step4=1
fi

# final check; all 4 steps
(( ngx_ws_done = step1 + step2 + step3 + step4 ))
if (( ngx_ws_done == 4 )); then
   ngx_ws_done=1
else
   ngx_ws_done=0
fi

cd ../..

}



# ############################################################### #
# Recording: Scripts                                              #
# ############################################################### #

# init.nginx-fcgi
# nginx-fcgi.pl
# nginx-fcgi.x86.boot
# htpasswd

build_nginx_scripts() {

dir=scripts
step1=0
step2=0


cd $dir/${OS_NAME}
print "\n##################################################"
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Submodule: $dir ${OS_NAME}" | tee -a ${BUILD_LOG}/${module}.${version}.log

# STEP 1
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 1 - Installing nginx wrappers ..." |\
 tee -a ${BUILD_LOG}/${module}.${version}.log

cp *nginx* htpasswd /opt/www/nginx/sbin
if (( $? != 0 )); then
    print "Error: cannot install nginx scripts !" |\
     tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step1=1
fi

# set smf directory
cp -pr smf /opt/www/nginx/
if (( $? != 0 )); then
    print "Error: cannot install additional smf scripts !" |\
      tee -a ${BUILD_LOG}/${module}.${version}.log
    rm /var/tmp/build.${module}
    exit 3
else
    step2=1
fi


# final check; all 2 steps
(( ngx_scripts_done = step1 + step2 ))
if (( ngx_scripts_done == 2 )); then
   ngx_scripts_done=1
else
   ngx_scripts_done=0
fi

cd ../..

}


# ############################################################### #
# Recording: Test Scripts                                         #
# ############################################################### #
test_rec_scripts() {

dir=tests
step1=0
step2=0
step3=0


cd $dir
print "\n##################################################"
print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Testing SDR" | tee -a ${BUILD_LOG}/${module}.${version}.log

# STEP 1
# Check all recorders if they are sane and execute properly

print "" >> ${BUILD_LOG}/${module}.${version}.log
print "Info: Step 1 - Check recorders" |\
 tee -a ${BUILD_LOG}/${module}.${version}.log

. /opt/sdr/bin/setenv
for r in sys cpu net nic hdw zone
do
    print "" >> ${BUILD_LOG}/${module}.${version}.log 2>&1
    print "Executing ${r}rec" | tee -a ${BUILD_LOG}/${module}.${version}.log
    if [[ $r == "nic" ]]; then
        ${SDR_BIN}/${r}rec_x64 >> ${BUILD_LOG}/${module}.${version}.log 2>&1
    else
        ${SDR_BIN}/${r}rec >> ${BUILD_LOG}/${module}.${version}.log 2>&1
    fi
    
    if (( $? != 0 )); then
        print "Error: cannot run ${r}rec !" |\
         tee -a ${BUILD_LOG}/${module}.${version}.log
        rm /var/tmp/build.${module}
        exit 3
    else
        ((step1=step1+1))
    fi
done

(( step1 = step1 / 5 ))

# final check; all 4 steps
(( tests_done = step1 ))
if (( tests_done == 1 )); then
   tests_done=1
else
   tests_done=0
fi

cd ..

}

